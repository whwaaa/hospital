<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../Css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../Css/bootstrap-responsive.css" />
    <link rel="stylesheet" type="text/css" href="../Css/style.css" />
    <script type="text/javascript" src="../Js/jquery.js"></script>
    <script type="text/javascript" src="../Js/bootstrap.js"></script>
    <script type="text/javascript" src="../Js/ckform.js"></script>
    <script type="text/javascript" src="../Js/common.js"></script>
    <style type="text/css">
        body {
            padding-bottom: 40px;
        }
        .sidebar-nav {
            padding: 9px 0;
        }

        @media (max-width: 980px) {
            /* Enable use of floated navbar text */
            .navbar-text.pull-right {
                float: none;
                padding-left: 5px;
                padding-right: 5px;
            }
        }
        .warning{
            border-color: red !important;
        }
    </style>
<script>
    let roleCheckFlag = false;
    let loginNameCheckFlag = false;
    let passwordCheckFlag = false;
    let trueNameCheckFlag = false;
    let emailCheckFlag = false;

    // 登录名的唯一性验证, 非空
    function loginNameCheck(u_loginName){
        if(u_loginName.value == null || u_loginName.value === "" || u_loginName.value === undefined){
            layer.msg("登录名不能为空", function(){})
            $("input[name='u_loginName']").addClass("warning")
        }else{
            $.ajax({
                type: "GET",
                url: "/user/loginname/" + u_loginName.value,
                data: {jwtToken:jwtToken},
                dataType: "json",
                success: function (data) {
                    if (data.code == 200){
                        loginNameCheckFlag = true;
                        $("input[name='u_loginName']").removeClass("warning")
                        // ajax查询有延迟,可在此处可设置再次自动提交
                        $('#useradd-btn').trigger("click");
                    }else{
                        layer.msg("登录名已存在，请重新输入。", function(){})
                        loginNameCheckFlag = false;
                        $("input[name='u_loginName']").addClass("warning")
                    }
                }
                // TODO: 后端拦截ajax请求进行登陆跳转需要前端相互配合, 每一个ajax请求都需要加上以下的代码
                ,complete : function(xhr, status) {
                    myComplete(xhr, status);
                }
            })
        }
    }
    // 密码强度的验证, 非空
    function passwordCheck(u_passWord){
        // 密码长度6-16位，必须包含有数字，字母及特殊字符。
        var reg = /^.*(?=.{6,16})(?=.*\d)(?=.*[A-z])(?=.*[!@#$%^&*?\(\)]).*$/;
        if(reg.test(u_passWord.value)){
            passwordCheckFlag = true;
            $("input[name='u_passWord']").removeClass("warning")
        } else {
            layer.msg("密码强度太弱,请重新设置", function(){})
            passwordCheckFlag = false;
            $("input[name='u_passWord']").addClass("warning")
        }
    }
    // 真实姓名的非空验证
    function trueNameCheck(u_loginName){
        if(u_loginName.value === "" || u_loginName.value === undefined){
            layer.msg("姓名不能为空", function(){})
            trueNameCheckFlag = false;
            $("input[name='u_trueName']").addClass("warning")
        } else {
            trueNameCheckFlag = true;
            $("input[name='u_trueName']").removeClass("warning")
        }
    }
    // 邮箱的正规合法验证
    function emailCheck(u_email){
        var reg = /^([a-zA-Z]|[0-9])(\w|\-)+@[a-zA-Z0-9]+\.([a-zA-Z]{2,4})$/;
        if(reg.test(u_email.value)){
            emailCheckFlag = true;
            $("input[name='u_email']").removeClass("warning")
        } else {
            layer.msg("邮箱格式不正确", function(){})
            emailCheckFlag = false;
            $("input[name='u_email']").addClass("warning")
        }
    }
    // 角色非空验证
    function roleCheck(r_id){
        if(r_id.value === "" || r_id.value === undefined){
            layer.msg("必须选择一个角色", function(){})
            roleCheckFlag = false;
            $("#r_id").addClass("warning")

        }else{
            roleCheckFlag = true;
            $("#r_id").removeClass("warning")
        }
    }

    $(function () {
        // // 角色查询
        // $.ajax({
        //     type: "GET",
        //     url: "/role/list",
        //     data: {jwtToken:jwtToken},
        //     dataType: "json",
        //     success: function (data) {
        //         if(data.code === 200){
        //             $.each(data.obj, function(){
        //                 $("#r_id").append("<option value='"+ this.r_id +"'>" + this.r_name);
        //             })
        //         }
        //     },
        //     complete : function(xhr, status) {
        //         myComplete(xhr, status);
        //     }
        // })
        // TODO: 等待角色查询启用上面代码, 下面代码暂时替代
        roles = [{"r_id":1,"r_isDel":0,"r_name":"管理员","r_state":1},{"r_id":2,"r_isDel":0,"r_name":"院长","r_state":1},{"r_id":3,"r_isDel":0,"r_name":"医生护士","r_state":1},{"r_id":4,"r_isDel":0,"r_name":"药品管理员","r_state":1}]
        $.each(roles, function(){
            $("#r_id").append("<option value='"+ this.r_id +"'>" + this.r_name);
        })

        $('#backid').click(function(){
            window.location.href="index.html";
        });

        $('#useradd-btn').click(function() {
            let r_id = $("#r_id").val();
            let u_email = $("input[name='u_email']").val();
            let u_trueName = $("input[name='u_trueName']").val();
            let u_passWord = $("input[name='u_passWord']").val();
            let u_loginName = $("input[name='u_loginName']").val();
            let u_state = $("input[name='u_state']:checked").val();

            if( !loginNameCheckFlag ){
                loginNameCheck(u_loginName);
                return false;
            }
            if( !passwordCheckFlag ){
                passwordCheck(u_passWord);
                return false;
            }
            if( !trueNameCheckFlag ){
                trueNameCheck(u_trueName);
                return false;
            }
            if( !emailCheckFlag ){
                emailCheck(u_email);
                return false;
            }
            if( !roleCheckFlag ){
                roleCheck(r_id);
                return false;
            }
            // 校验没有问题, 发起请求添加用户
            layer.load(0)
            $.ajax({
                type: "POST",
                url: "/user",
                data: {jwtToken:jwtToken,r_id:r_id,u_email:u_email,u_trueName:u_trueName,
                    u_passWord:u_passWord,u_loginName:u_loginName,u_state:u_state},
                dataType: "json",
                success: function (data) {
                    layer.closeAll()
                    if (data.code == 201){
                        layer.msg("添加成功")
                        setTimeout(function () {
                            window.location.href = "index.html";
                        },500)
                    }else{
                        layer.msg(data.msg,function(){})
                    }
                },
                complete : function(xhr, status) {
                    myComplete(xhr, status);
                }
            })
        })
    })
</script>
</head>
<body>
<form action="/user" method="post" class="definewidth m20">
    <table class="table table-bordered table-hover definewidth m10">
        <tr>
            <td width="10%" class="tableleft">登录名</td>
            <td><input onblur="loginNameCheck(this)" type="text" name="u_loginName"/></td>
        </tr>
        <tr>
            <td class="tableleft">密码</td>
            <td><input onblur="passwordCheck(this)" type="password" name="u_passWord"/></td>
        </tr>
        <tr>
            <td class="tableleft">真实姓名</td>
            <td><input onblur="trueNameCheck(this)" type="text" name="u_trueName"/></td>
        </tr>
        <tr>
            <td class="tableleft">邮箱</td>
            <td><input onblur="emailCheck(this)" type="text" name="u_email"/></td>
        </tr>
        <tr>
            <td class="tableleft">状态</td>
            <td>
                <input type="radio" name="u_state" value="0" checked/> 启用
                <input type="radio" name="u_state" value="1" /> 禁用
            </td>
        </tr>
        <tr>
            <td class="tableleft">角色</td>
            <td>
            	<select onblur="roleCheck(this)" id="r_id" name="r_id">
        			<option value="">--请选择--
<!--        			<option value="1">管理员-->
<!--        			<option value="2">院长-->
<!--            		<option value="3">医生护士-->
       			 </select>
        	</td>
        </tr>
        <tr>
            <td class="tableleft"></td>
            <td>
                <button id="useradd-btn" class="btn btn-primary" type="button">添加</button>&nbsp;&nbsp;<button type="button" class="btn btn-success" name="backid" id="backid">返回列表</button>
            </td>
        </tr>
    </table>
</form>
</body>
</html>