<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../Css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../Css/bootstrap-responsive.css" />
    <link rel="stylesheet" type="text/css" href="../Css/style.css" />
    <script type="text/javascript" src="../Js/jquery.js"></script>
    <script type="text/javascript" src="../Js/bootstrap.js"></script>
    <script type="text/javascript" src="../Js/ckform.js"></script>
    <script type="text/javascript" src="../Js/common.js"></script>

 

    <style type="text/css">
        body {
            padding-bottom: 40px;
        }
        .sidebar-nav {
            padding: 9px 0;
        }

        @media (max-width: 980px) {
            /* Enable use of floated navbar text */
            .navbar-text.pull-right {
                float: none;
                padding-left: 5px;
                padding-right: 5px;
            }
        }
        .warning{
            border-color: red !important;
        }

    </style>
</head>
<body>
<form action="index.html" method="post" class="definewidth m20">
<input type="hidden" name="id" value="{$user.id}" />
    <table class="table table-bordered table-hover definewidth m10">
        <tr>
            <td width="10%" class="tableleft">登录名</td>
            <td id="uLoginName"></td>
        </tr>
        <tr>
            <td class="tableleft">密码</td>
            <td><input onblur="passwordCheck(this)" type="password" name="uPassword"/></td>
        </tr>
        <tr>
            <td class="tableleft">真实姓名</td>
            <td><input onblur="trueNameCheck(this)" type="text" name="uTrueName" value=""/></td>
        </tr>
        <tr>
            <td class="tableleft">邮箱</td>
            <td><input onblur="emailCheck(this)" type="text" name="uEmail" value=""/></td>
        </tr>
        <tr>
            <td class="tableleft">状态</td>
            <td>
                <input type="radio" name="uState" value="0" /> 启用
                <input type="radio" name="uState" value="1" checked/> 禁用
            </td>
        </tr>
        <tr>
            <td class="tableleft">角色</td>
            <td>
            	<select onblur="roleCheck(this)" id="rId" name="rId">
        			<option value="">--请选择--
<!--        			<option value="1">管理员-->
<!--        			<option value="2">院长-->
<!--            		<option value="3">医生护士-->
       			 </select>
        	</td>
        </tr>
        <tr>
            <td class="tableleft"></td>
            <td>
                <button id="userEdit" class="btn btn-primary" type="button">更新</button>&nbsp;&nbsp;<button type="button" class="btn btn-success" name="backid" id="backid">返回列表</button>
            </td>
        </tr>
    </table>
</form>
</body>
</html>
<script>
    let roleCheckFlag = true;
    let passwordCheckFlag = true;
    let trueNameCheckFlag = true;
    let emailCheckFlag = true;

    // 密码强度的验证, 非空
    function passwordCheck(uPassword){
        // 密码长度6-16位，必须包含有数字，字母及特殊字符。
        var reg = /^.*(?=.{6,16})(?=.*\d)(?=.*[A-z])(?=.*[!@#$%^&*?\(\)]).*$/;
        if(reg.test(uPassword.value)){
            passwordCheckFlag = true;
            $("input[name='uPassword']").removeClass("warning")
        } else {
            layer.msg("密码强度太弱,请重新设置", function(){})
            passwordCheckFlag = false;
            $("input[name='uPassword']").addClass("warning")
        }
    }
    // 真实姓名的非空验证
    function trueNameCheck(uLoginName){
        if(uLoginName.value === "" || uLoginName.value === undefined){
            layer.msg("姓名不能为空", function(){})
            trueNameCheckFlag = false;
            $("input[name='uTrueName']").addClass("warning")
        } else {
            trueNameCheckFlag = true;
            $("input[name='uTrueName']").removeClass("warning")
        }
    }
    // 邮箱的正规合法验证
    function emailCheck(uEmail){
        var reg = /^([a-zA-Z]|[0-9])(\w|\-)+@[a-zA-Z0-9]+\.([a-zA-Z]{2,4})$/;
        if(reg.test(uEmail.value)){
            emailCheckFlag = true;
            $("input[name='uEmail']").removeClass("warning")
        } else {
            layer.msg("邮箱格式不正确", function(){})
            emailCheckFlag = false;
            $("input[name='uEmail']").addClass("warning")
        }
    }
    // 角色非空验证
    function roleCheck(rId){
        if(rId.value === "" || rId.value === undefined){
            layer.msg("必须选择一个角色", function(){})
            roleCheckFlag = false;
            $("#rId").addClass("warning")

        }else{
            roleCheckFlag = true;
            $("#rId").removeClass("warning")
        }
    }

    String.prototype.GetValue= function(para) {
        let reg = new RegExp("(^|&)"+ para +"=([^&]*)(&|$)");
        let r = this.substr(this.indexOf("\?")+1).match(reg);
        if (r!=null) return unescape(r[2]); return null;
    }
    // 回调地址参数
    let pageNum = document.location.toString().GetValue("pageNum");
    let pageSize = document.location.toString().GetValue("pageSize");
    let rId = document.location.toString().GetValue("rId");

    function queryUser(){
        layer.load(0)
        // 通过rId查询用户信息
        $.ajax({
            type: "GET",
            url: "/user/"+ rId,
            data: {jwtToken:jwtToken},
            success: function (data) {
                layer.closeAll();
                if(data.code === 200){
                    // 填充数据
                    loadDate(data.obj)
                }else{
                    layer.msg(data.msg,function(){})
                }
            }
            // TODO: 后端拦截ajax请求进行登陆跳转需要前端相互配合, 每一个ajax请求都需要加上以下的代码
            ,complete : function(xhr, status) {
                myComplete(xhr, status);
            }
        });
    }

    $(function () {

        // // 角色查询
        // $.ajax({
        //     type: "GET",
        //     url: "/role/list",
        //     data: {jwtToken:jwtToken},
        //     dataType: "json",
        //     success: function (data) {
        //         if(data.code === 200){
        //             $.each(data.obj, function(){
        //                 $("#rId").append("<option value='"+ this.rId +"'>" + this.r_name);
        //             })
        //             // 查询用户信息
        //             queryUser();
        //         }
        //     },
        //     complete : function(xhr, status) {
        //         myComplete(xhr, status);
        //     }
        // })
        // TODO: 等待角色查询启用上面代码, 下面代码暂时替代
        roles = [{"rId":1,"r_isDel":0,"r_name":"管理员","r_state":1},{"rId":2,"r_isDel":0,"r_name":"院长","r_state":1},{"rId":3,"r_isDel":0,"r_name":"医生护士","r_state":1},{"rId":4,"r_isDel":0,"r_name":"药品管理员","r_state":1}]
        $.each(roles, function(){
            $("#rId").append("<option value='"+ this.rId +"'>" + this.r_name);
        })
        setTimeout(function(){
            // 查询用户信息
            queryUser();
        }, 500)

        // 返回
        $('#backid').click(function(){
            window.location.href="index.html?pageNum=" + pageNum + "&pageSize=" + pageSize;
        });

        // 更新
        $('#userEdit').click(function() {
            let rId = $("#rId").val();
            let uEmail = $("input[name='uEmail']").val();
            let uTrueName = $("input[name='uTrueName']").val();
            let uPassword = $("input[name='uPassword']").val();
            let uState = $("input[name='uState']:checked").val();

            if( !passwordCheckFlag ){
                passwordCheck(uPassword);
                return false;
            }
            if( !trueNameCheckFlag ){
                trueNameCheck(uTrueName);
                return false;
            }
            if( !emailCheckFlag ){
                emailCheck(uEmail);
                return false;
            }
            if( !roleCheckFlag ){
                roleCheck(rId);
                return false;
            }
            // 校验没有问题, 发起请求添加用户
            layer.load(0)
            $.ajax({
                type: "POST",
                url: "/user/" + rId,
                data: {_method:"PUT",jwtToken:jwtToken,rId:rId,uEmail:uEmail,uTrueName:uTrueName,
                    uPassword:uPassword,uState:uState},
                dataType: "json",
                success: function (data) {
                    layer.closeAll()
                    if (data.code == 200){
                        layer.msg("修改成功")
                        setTimeout(function () {
                            $('#backid').trigger("click");
                        },500)
                    }else{
                        layer.msg(data.msg,function(){})
                    }
                }
                ,complete : function(xhr, status) {
                    myComplete(xhr, status);
                }
            })
        })
    });

    // 填充查询数据
    function loadDate(user){
        console.log(user);
        $("#uLoginName").text(user.uLoginName)
        $("input[name='uPassword']").val(user.uPassword)
        $("input[name='uTrueName']").val(user.uTrueName)
        $("input[name='uEmail']").val(user.uEmail)
        if(user.uState == 0){
            $(':radio[name="uState"]').eq(0).prop("checked",true)
            $(':radio[name="uState"]').eq(1).attr("checked",false)
        }else{
            $(':radio[name="uState"]').eq(1).prop("checked",true)
            $(':radio[name="uState"]').eq(0).attr("checked",false)
        }
        $("select[name='rId']").val(user.rId)
    }


</script>