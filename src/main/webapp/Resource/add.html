<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../Css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../Css/bootstrap-responsive.css" />
    <link rel="stylesheet" type="text/css" href="../Css/style.css" />
    <script type="text/javascript" src="../Js/jquery.js"></script>
    <script type="text/javascript" src="../Js/bootstrap.js"></script>
    <script type="text/javascript" src="../Js/ckform.js"></script>
    <script type="text/javascript" src="../Js/common.js"></script>

 

    <style type="text/css">
        body {
            padding-bottom: 40px;
        }
        .sidebar-nav {
            padding: 9px 0;
        }

        @media (max-width: 980px) {
            /* Enable use of floated navbar text */
            .navbar-text.pull-right {
                float: none;
                padding-left: 5px;
                padding-right: 5px;
            }
        }
        .warning{
            border-color: red !important;
        }

    </style>
    <script>
        String.prototype.GetValue= function(para) {
            let reg = new RegExp("(^|&)"+ para +"=([^&]*)(&|$)");
            let r = this.substr(this.indexOf("\?")+1).match(reg);
            if (r!=null) return unescape(r[2]); return null;
        }
        // 地址参数
        let pageNum = document.location.toString().GetValue("pageNum");
        let pageSize = document.location.toString().GetValue("pageSize");

        let urlCheckFlat = false;   // url检测通过标志
        let urlIsValid = true;
        let mNameCheckFlag = false; // mName检测通过标志
        // 刚按下提交, 被验证拦截时的标志 true刚按下
        let presBtnFlag = false;
        // 设置定时器, 防止onblur和onclick发生冲突, 确保onclick先执行
        let mNameCheckTime;
        let urlCheckTime;

        // 资源名的唯一性验证, 非空
        function mNameCheck(mName){
            mNameCheckTime = setTimeout(function(){
                if(mName == null || mName === "" || mName === undefined){
                    layer.msg("资源名不能为空", function(){})
                    $("input[name='mName']").addClass("warning")
                }else{
                    $.ajax({
                        type: "GET",
                        url: "/menu/m-name/" + mName,
                        data: {jwtToken:jwtToken},
                        dataType: "json",
                        success: function (data) {
                            if (data.code == 200){
                                mNameCheckFlag = true;
                                $("input[name='mName']").removeClass("warning")
                                if(presBtnFlag){
                                    // 防止重复提交
                                    presBtnFlag = false;
                                    // ajax查询有延迟,可在此处可设置再次自动提交
                                    addMenu();
                                }
                            }else{
                                layer.msg("资源名已存在，请重新输入。", function(){})
                                mNameCheckFlag = false;
                                $("input[name='mName']").addClass("warning")
                            }
                        }
                        ,complete : function(xhr, status) {
                            myComplete(xhr, status);
                        }
                    })
                }
            }, 100)
        }
        // 资源有效性检测
        function urlCheck(url){
            urlCheckTime = setTimeout(function(){
                // 只要修改url,就必须等待检测完成才能提交
                urlCheckFlat = false;
                if(url.trim() === "" ){
                    layer.msg("资源URL不能为空", function(){})
                    $("input[name='mUrl']").addClass("warning");
                }else{
                    $("input[name='mUrl']").removeClass("warning");
                    layer.load(0)
                    $.ajax({
                        type: "GET",
                        url: "/" + url,
                        success: function (data) {
                            urlCheckFlat = true;
                            layer.closeAll();
                            $("input[name='mUrl']").removeClass("warning");
                            urlIsValid = true;
                            $(':radio[name="mState"]').eq(0).prop("checked",true)
                            $(':radio[name="mState"]').eq(1).attr("checked",false)
                            layer.msg("检测URL可用")
                            if(presBtnFlag){
                                // 防止重复提交
                                presBtnFlag = false;
                                // ajax查询有延迟,可在此处可设置再次自动提交
                                addMenu();
                            }
                        },
                        error: function (){
                            urlCheckFlat = true;
                            layer.closeAll();
                            // layer.msg("资源url无效！", function(){})
                            // $("input[name='mUrl']").addClass("warning");
                            urlIsValid = false;
                            $(':radio[name="mState"]').eq(1).prop("checked",true)
                            $(':radio[name="mState"]').eq(0).attr("checked",false)
                            layer.msg("检测到URL不可用")
                            if(presBtnFlag){
                                // 防止重复提交
                                presBtnFlag = false;
                                // ajax查询有延迟,可在此处可设置再次自动提交
                                setTimeout(function(){
                                    addMenu();
                                },500)
                            }
                        }
                    })
                }
            },100)

        }

        // 添加
        function addMenu(){
            // 防止onblur和onclick发生冲突, 确保onclick先执行
            clearTimeout(mNameCheckTime);
            clearTimeout(urlCheckTime);
            let mUrl = $("input[name='mUrl']").val();
            let mName = $("input[name='mName']").val()
            let mState = $("input[name='mState']:checked").val()
            // 资源名的唯一性验证
            if(mNameCheckFlag === false){
                presBtnFlag = true;
                mNameCheck(mName);
                return false;
            }
            // 资源有效性检测
            if(urlCheckFlat === false){
                presBtnFlag = true;
                urlCheck(mUrl);
                return false;
            }
            // 防止重复添加
            presBtnFlag = false;
            layer.load(0)
            $.ajax({
                type: "POST",
                url: "/menu",
                data: {jwtToken:jwtToken,mUrl:mUrl,mState:mState,mName:mName},
                dataType: "json",
                success: function (data) {
                    layer.closeAll()
                    if (data.code == 201){
                        layer.msg("添加成功")
                        setTimeout(function(){
                            // 返回index
                            $('#backid').trigger("click");
                        },500)
                    }else{
                        layer.msg(data.msg,function(){})
                    }
                },
                complete : function(xhr, status) {
                    myComplete(xhr, status);
                }
            })

        }

        $(function () {
            // 返回列表
            $('#backid').click(function(){
                // if(pageSize == 'null')
                //     pageSize = "";
                // if(pageNum == 'null')
                //     pageNum = "";
                // window.location.href="index.html?pageNum=" + pageNum + "&pageSize=" + pageSize;
                window.location.href="index.html";
            });
            // 监听mState
            $("input[name='mState']").on("click", function(){
                if(!urlIsValid){
                    $(':radio[name="mState"]').eq(1).prop("checked",true)
                    $(':radio[name="mState"]').eq(0).attr("checked",false)
                    layer.msg("检测到URL无效,不能设置为有效",function(){})
                }
            })
        });
    </script>
</head>
<body>
<form action="index.html" method="post" class="definewidth m20">
<input type="hidden" name="id" value="{$user.id}" />
    <table class="table table-bordered table-hover definewidth m10">
        <tr>
            <td width="10%" class="tableleft">资源名称</td>
            <td><input onblur="mNameCheck(this.value)" type="text" name="mName"/></td>
        </tr>
        <tr>
            <td class="tableleft">url</td>
            <td><input onblur="urlCheck(this.value)" type="text" name="mUrl"/></td>
        </tr>
        <tr>
            <td class="tableleft">是否有效</td>
            <td>
                <input type="radio" name="mState" value="0" checked/> 有效
                <input type="radio" name="mState" value="1" /> 无效
            </td>
        </tr>
        <tr>
            <td class="tableleft"></td>
            <td>
                <button onclick="addMenu()" class="btn btn-primary" type="button">添加</button>&nbsp;&nbsp;<button type="button" class="btn btn-success" name="backid" id="backid">返回列表</button>
            </td>
        </tr>
    </table>
</form>
</body>
</html>